openapi: 3.0.3
info:
  title: First Therapy Backend API
  description: |
    REST API for the First Therapy platform.

    **Authentication:** Protected endpoints require a JWT token passed via `Authorization: Bearer <token>` header.

    **Payment Providers:** The billing system supports multiple providers â€” LemonSqueezy and Dodo Payments.
  version: 1.0.0
  contact:
    name: The Brain Psych
    url: https://github.com/thebrainpsych

servers:
  - url: http://localhost:3000
    description: Local development
  - url: https://api.firsttherapy.com
    description: Production (example)

tags:
  - name: Calendar
    description: Therapy session scheduling with Google Calendar & Meet
  - name: Billing
    description: Checkout and payment webhook handling

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for protected endpoints

  schemas:
    ScheduleSessionRequest:
      type: object
      required: [ownerEmail, startTime]
      properties:
        ownerEmail:
          type: string
          format: email
          description: Email of the calendar owner (therapist)
          example: "therapist@example.com"
        therapistName:
          type: string
          description: Name of the therapist
          example: "Dr. Smith"
        startTime:
          type: string
          format: date-time
          description: Session start time in ISO 8601 format
          example: "2025-06-15T10:00:00Z"
        participants:
          type: array
          description: List of participant emails to invite
          items:
            type: object
            properties:
              email:
                type: string
                format: email
          example:
            - email: "patient@example.com"

    ScheduleSessionResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        meetLink:
          type: string
          format: uri
          description: Google Meet link for the session
          example: "https://meet.google.com/abc-defg-hij"
        message:
          type: string
          example: "Session scheduled. Calendar invite sent."

    CheckoutRequest:
      type: object
      required: [productId]
      properties:
        provider:
          type: string
          enum: [lemon, dodo]
          description: Payment provider to use (defaults to server config)
          example: "dodo"
        productId:
          type: string
          description: ID of the product/plan to purchase
          example: "prod_abc123"
        quantity:
          type: integer
          description: Quantity of the product
          example: 1

    CheckoutResponse:
      type: object
      properties:
        checkoutUrl:
          type: string
          format: uri
          description: URL to redirect the user to for payment
          example: "https://checkout.dodopayments.com/session/xyz"

    ErrorResponse:
      type: object
      properties:
        message:
          type: string
          example: "Missing token"

    ErrorResponseWithError:
      type: object
      properties:
        error:
          type: string
          example: "ownerEmail and startTime are required"

paths:
  /calendar/schedule:
    post:
      tags: [Calendar]
      summary: Schedule a therapy session
      description: |
        Creates a Google Calendar event with a Google Meet link and sends calendar invites to all participants.
        The owner email is automatically added to participants if not already included.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ScheduleSessionRequest"
      responses:
        "200":
          description: Session scheduled successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScheduleSessionResponse"
        "400":
          description: Missing required fields
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponseWithError"
              example:
                error: "ownerEmail and startTime are required"

  /billing/checkout:
    post:
      tags: [Billing]
      summary: Create a checkout session
      description: Creates a payment checkout session with the specified provider and returns a checkout URL to redirect the user to.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CheckoutRequest"
      responses:
        "200":
          description: Checkout session created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CheckoutResponse"
        "400":
          description: Missing productId
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "productId required"
        "401":
          description: Missing or invalid JWT token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Missing token"

  /billing/webhook:
    post:
      tags: [Billing]
      summary: Payment webhook
      description: |
        Handles incoming webhook events from payment providers (LemonSqueezy / Dodo Payments).
        Expects the raw request body for signature verification.
      requestBody:
        required: true
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        "200":
          description: Webhook processed successfully
