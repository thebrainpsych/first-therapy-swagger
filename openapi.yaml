openapi: 3.0.3
info:
  title: First Therapy Backend API
  description: |
    REST API for the First Therapy platform.

    **Authentication:** Protected endpoints require a JWT token passed via `Authorization: Bearer <token>` header.

    **Payment Providers:** The billing system supports multiple providers â€” LemonSqueezy and Dodo Payments.
  version: 1.0.0
  contact:
    name: The Brain Psych
    url: https://github.com/thebrainpsych

servers:
  - url: http://localhost:3000
    description: Local development
  - url: https://api.firsttherapy.com
    description: Production (example)

tags:
  - name: Calendar
    description: Therapy session scheduling with Google Calendar & Meet
  - name: Billing
    description: Checkout and payment webhook handling
  - name: Notifications
    description: Send notifications to users via multiple channels

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for protected endpoints
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key
      description: API key for notifications endpoints

  schemas:
    ScheduleSessionRequest:
      type: object
      required: [ownerEmail, startTime]
      properties:
        ownerEmail:
          type: string
          format: email
          description: Email of the calendar owner (therapist)
          example: "therapist@example.com"
        therapistName:
          type: string
          description: Name of the therapist
          example: "Dr. Smith"
        startTime:
          type: string
          format: date-time
          description: Session start time in ISO 8601 format
          example: "2025-06-15T10:00:00Z"
        participants:
          type: array
          description: List of participant emails to invite
          items:
            type: object
            properties:
              email:
                type: string
                format: email
          example:
            - email: "patient@example.com"

    ScheduleSessionResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        meetLink:
          type: string
          format: uri
          description: Google Meet link for the session
          example: "https://meet.google.com/abc-defg-hij"
        message:
          type: string
          example: "Session scheduled. Calendar invite sent."

    CheckoutRequest:
      type: object
      required: [productId]
      properties:
        provider:
          type: string
          enum: [lemon, dodo]
          description: Payment provider to use (defaults to server config)
          example: "dodo"
        productId:
          type: string
          description: ID of the product/plan to purchase
          example: "prod_abc123"
        quantity:
          type: integer
          description: Quantity of the product
          example: 1

    CheckoutResponse:
      type: object
      properties:
        checkoutUrl:
          type: string
          format: uri
          description: URL to redirect the user to for payment
          example: "https://checkout.dodopayments.com/session/xyz"

    ErrorResponse:
      type: object
      properties:
        message:
          type: string
          example: "Missing token"

    ErrorResponseWithError:
      type: object
      properties:
        error:
          type: string
          example: "ownerEmail and startTime are required"

    NotificationSendRequest:
      type: object
      required: [title, message, channels]
      properties:
        broadcast:
          type: boolean
          description: Whether to send to all users. Use this OR user_ids, not both.
          example: true
        user_ids:
          type: array
          description: List of user IDs to send notification to. Use this OR broadcast, not both.
          items:
            type: string
            format: uuid
          example: ["0c20a452-2714-437d-a25e-bb2fabb9b286", "843cca93-4800-4cff-9c38-7a2205de574e"]
        title:
          type: string
          description: Notification title
          example: "Broadcast Test"
        message:
          type: string
          description: Notification message body
          example: "This is sent to all users."
        type:
          type: string
          description: Type/category of the notification
          enum: [system, alert, reminder, promotion]
          example: "system"
        channels:
          type: array
          description: Delivery channels for the notification
          items:
            type: string
            enum: [in_app, push, email]
          example: ["in_app", "push"]
        metadata:
          type: object
          description: Additional metadata and custom data for the notification
          properties:
            screen:
              type: string
              description: Target screen/page in the app
              example: "dashboard"
            custom_data:
              type: string
              description: Any additional custom data
              example: "example"
          additionalProperties: true

    NotificationSendResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Whether the notification was sent successfully
          example: true
        type:
          type: string
          description: Type of notification sent ("broadcast" for all users, "multiple" for 2+ users, "single" for 1 user)
          enum: [broadcast, multiple, single]
          example: "broadcast"
        count:
          type: integer
          description: Number of users the notification was sent to
          example: 43

    NotificationRegisterTokenRequest:
      type: object
      required: [token, device_type]
      properties:
        token:
          type: string
          description: Push notification token from the mobile app (e.g., Expo push token)
          example: "ExponentPushToken[xxxxxxxxxxxxxxxxxxxxxx]"
        device_type:
          type: string
          description: Type of device
          enum: [ios, android]
          example: "android"

    NotificationRegisterTokenResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Whether the token was registered successfully
          example: true

    NotificationUnregisterTokenRequest:
      type: object
      required: [token]
      properties:
        token:
          type: string
          description: Push notification token to unregister
          example: "ExponentPushToken[xxxx...]"

    NotificationObject:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique notification ID
          example: "7a659a68-bc6e-4019-83c1-b15af650366b"
        user_id:
          type: string
          format: uuid
          description: User ID who received the notification
          example: "843cca93-4800-4cff-9c38-7a2205de574e"
        title:
          type: string
          description: Notification title
          example: "Multi User Test"
        message:
          type: string
          description: Notification message
          example: "This goes to multiple users."
        type:
          type: string
          description: Notification type/category
          enum: [system, alert, reminder, promotion]
          example: "system"
        channels:
          type: array
          items:
            type: string
          description: Channels used to send the notification
          example: ["in_app", "push"]
        metadata:
          type: object
          nullable: true
          description: Additional metadata attached to the notification
          example: null
        is_read:
          type: boolean
          description: Whether the notification has been read
          example: false
        read_at:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when the notification was read
          example: null
        created_at:
          type: string
          format: date-time
          description: Timestamp when the notification was created
          example: "2026-02-18T20:13:42.682571+00:00"

    NotificationListResponse:
      type: object
      properties:
        data:
          type: array
          description: List of notifications
          items:
            $ref: "#/components/schemas/NotificationObject"
        total:
          type: integer
          description: Total number of notifications available
          example: 4
        limit:
          type: integer
          description: Limit used in the request
          example: 1
        offset:
          type: integer
          description: Offset used in the request
          example: 0
        hasMore:
          type: boolean
          description: Whether there are more notifications to fetch
          example: true

    NotificationUnreadCountResponse:
      type: object
      properties:
        count:
          type: integer
          description: Number of unread notifications for the user
          example: 2

paths:
  /calendar/schedule:
    post:
      tags: [Calendar]
      summary: Schedule a therapy session
      description: |
        Creates a Google Calendar event with a Google Meet link and sends calendar invites to all participants.
        The owner email is automatically added to participants if not already included.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ScheduleSessionRequest"
      responses:
        "200":
          description: Session scheduled successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScheduleSessionResponse"
        "400":
          description: Missing required fields
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponseWithError"
              example:
                error: "ownerEmail and startTime are required"

  /billing/checkout:
    post:
      tags: [Billing]
      summary: Create a checkout session
      description: Creates a payment checkout session with the specified provider and returns a checkout URL to redirect the user to.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CheckoutRequest"
      responses:
        "200":
          description: Checkout session created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CheckoutResponse"
        "400":
          description: Missing productId
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "productId required"
        "401":
          description: Missing or invalid JWT token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Missing token"

  /billing/webhook:
    post:
      tags: [Billing]
      summary: Payment webhook
      description: |
        Handles incoming webhook events from payment providers (LemonSqueezy / Dodo Payments).
        Expects the raw request body for signature verification.
      requestBody:
        required: true
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        "200":
          description: Webhook processed successfully

  /notifications/send:
    post:
      tags: [Notifications]
      summary: Send notifications to users
      description: |
        Send notifications to users via multiple channels (in-app, push, email).
        
        **Three modes:**
        1. **Broadcast mode**: Set `broadcast: true` to send to all users (response type: "broadcast")
        2. **Multiple users mode**: Provide `user_ids` array with 2+ users (response type: "multiple")
        3. **Single user mode**: Provide `user_ids` array with 1 user (response type: "single")
        
        Optional fields include `type` (notification category) and `metadata` (custom data).
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NotificationSendRequest"
            examples:
              broadcast:
                summary: Broadcast to all users
                value:
                  broadcast: true
                  title: "Broadcast Test"
                  message: "This is sent to all users."
                  channels: ["in_app", "push"]
              multiple:
                summary: Send to multiple specific users
                value:
                  user_ids: ["0c20a452-2714-437d-a25e-bb2fabb9b286", "843cca93-4800-4cff-9c38-7a2205de574e"]
                  title: "Multi User Test"
                  message: "This goes to multiple users."
                  channels: ["in_app", "push"]
              single:
                summary: Send to a single user with metadata
                value:
                  user_ids: ["0c20a452-2714-437d-a25e-bb2fabb9b286"]
                  title: "Test Push Notification quite state"
                  message: "This notification should appear on your mobile."
                  type: "system"
                  channels: ["in_app", "push"]
                  metadata:
                    screen: "dashboard"
                    custom_data: "example"
      responses:
        "200":
          description: Notification sent successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NotificationSendResponse"
              examples:
                broadcast:
                  summary: Broadcast response
                  value:
                    success: true
                    type: "broadcast"
                    count: 43
                multiple:
                  summary: Multiple users response
                  value:
                    success: true
                    type: "multiple"
                    count: 2
                single:
                  summary: Single user response
                  value:
                    success: true
                    type: "single"
                    count: 1
        "400":
          description: Missing required fields or invalid parameters
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "title, message, and channels are required"
        "401":
          description: Missing or invalid API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Invalid x-api-key"

  /notifications/register-token:
    post:
      tags: [Notifications]
      summary: Register push notification token
      description: |
        Register or update a device's push notification token.
        This token is used to send push notifications to the mobile app.
        Typically called when the app starts or when a new token is generated.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NotificationRegisterTokenRequest"
            examples:
              android:
                summary: Register Android device token
                value:
                  token: "ExponentPushToken[xxxxxxxxxxxxxxxxxxxxxx]"
                  device_type: "android"
              ios:
                summary: Register iOS device token
                value:
                  token: "ExponentPushToken[yyyyyyyyyyyyyyyyyyyy]"
                  device_type: "ios"
      responses:
        "200":
          description: Push notification token registered successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NotificationRegisterTokenResponse"
        "400":
          description: Missing required fields
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "token and device_type are required"
        "401":
          description: Missing or invalid JWT token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Missing or invalid token"

  /notifications:
    get:
      tags: [Notifications]
      summary: Get user notifications
      description: |
        Retrieve paginated list of notifications for the authenticated user.
        Notifications are sorted by creation date (newest first).
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          description: Number of notifications to fetch (pagination size)
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 100
          example: 10
        - name: offset
          in: query
          description: Number of notifications to skip (pagination offset)
          schema:
            type: integer
            default: 0
            minimum: 0
          example: 0
      responses:
        "200":
          description: List of notifications retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NotificationListResponse"
              example:
                data:
                  - id: "7a659a68-bc6e-4019-83c1-b15af650366b"
                    user_id: "843cca93-4800-4cff-9c38-7a2205de574e"
                    title: "Multi User Test"
                    message: "This goes to multiple users."
                    type: "system"
                    channels: ["in_app", "push"]
                    metadata: null
                    is_read: false
                    read_at: null
                    created_at: "2026-02-18T20:13:42.682571+00:00"
                total: 4
                limit: 1
                offset: 0
                hasMore: true
        "400":
          description: Invalid pagination parameters
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "limit must be between 1 and 100"
        "401":
          description: Missing or invalid JWT token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Missing or invalid token"

  /notifications/unread-count:
    get:
      tags: [Notifications]
      summary: Get unread notification count
      description: |
        Get the count of unread notifications for the authenticated user.
        Useful for displaying a badge in the UI.
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Unread notification count retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NotificationUnreadCountResponse"
              example:
                count: 2
        "401":
          description: Missing or invalid JWT token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Missing or invalid token"

  /notifications/unregister-token:
    post:
      tags: [Notifications]
      summary: Unregister push notification token
      description: |
        Unregister or remove a device's push notification token.
        Call this when the user logs out or uninstalls the app.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NotificationUnregisterTokenRequest"
            example:
              token: "ExponentPushToken[xxxx...]"
      responses:
        "200":
          description: Push notification token unregistered successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NotificationRegisterTokenResponse"
        "400":
          description: Missing token field
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Missing or invalid token"

  /notifications/read-all:
    patch:
      tags: [Notifications]
      summary: Mark all notifications as read
      description: |
        Mark all unread notifications as read for the authenticated user.
      security:
        - BearerAuth: []
      responses:
        "200":
          description: All notifications marked as read successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NotificationRegisterTokenResponse"
              example:
                success: true
        "401":
          description: Missing or invalid JWT token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Missing or invalid token"
  /notifications/read/{notification_id}:
    patch:
      tags: [Notifications]
      summary: Mark a notification as read
      description: |
        Mark a specific notification as read for the authenticated user.
      security:
        - BearerAuth: []
      parameters:
        - name: notification_id
          in: path
          required: true
          description: The ID of the notification to mark as read
          schema:
            type: string
            format: uuid
          example: "d0a0621c-65e6-4c9e-8431-4dd5e40494c4"
      responses:
        "200":
          description: Notification marked as read successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NotificationRegisterTokenResponse"
              example:
                success: true
        "400":
          description: Invalid notification ID format
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Invalid notification ID format"
        "404":
          description: Notification not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Notification not found"
        "401":
          description: Missing or invalid JWT token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Missing or invalid token"